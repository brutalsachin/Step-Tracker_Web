<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Navigation with 3D Arrow</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        #mapContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            z-index: 2;
            overflow: hidden;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 60%;
            z-index: 3;
            font-size: 16px;
        }
        .btn {
            padding: 10px;
            margin: 5px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <!-- Live Video Feed -->
    <div id="videoContainer">
        <video id="video" autoplay></video>
    </div>

    <!-- Leaflet Map Container -->
    <div id="mapContainer"></div>

    <!-- Controls -->
    <div id="controls">
        <button class="btn" id="resetBtn">RESET</button>
        <button class="btn" id="showHideMapBtn">SHOW MAP</button>
        <p id="direction">Heading: 0°</p>
        <p id="steps">Steps: 0</p>
        <p id="orientation">Orientation: North</p>
    </div>

    <!-- Three.js Setup -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        let video = document.getElementById('video');
        let showHideMapBtn = document.getElementById('showHideMapBtn');
        let mapVisible = false;
        let videoStream;
        let arrow;
        let scene, camera, renderer, arrowObject;

        // Set up Leaflet Map
        let map = L.map('mapContainer').setView([26.4500, 80.1930], 18); // PSIT Kanpur Coordinates

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Restrict zoom level for PSIT campus map
        map.setMaxZoom(18);

        // Set up video stream (rear camera)
        async function initCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = videoStream;
            } catch (err) {
                console.error('Error accessing camera: ', err);
            }
        }

        // Set up Three.js scene and 3D arrow
        function init3DArrow() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth / 2, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Arrow Geometry and Material
            const arrowGeometry = new THREE.ConeGeometry(0.5, 2, 8);
            const arrowMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            arrowObject = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrowObject.rotation.x = Math.PI / 2; // Rotate to point the arrow upwards
            scene.add(arrowObject);

            camera.position.z = 5;
        }

        // Update arrow orientation
        function updateArrowOrientation(heading) {
            arrowObject.rotation.y = THREE.MathUtils.degToRad(heading);
        }

        // Rotate arrow every frame based on heading
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Handle device orientation
        window.addEventListener('deviceorientation', function(event) {
            let heading = event.alpha || 0; // Heading in degrees
            document.getElementById('direction').innerText = `Heading: ${heading.toFixed(2)}°`;
            updateArrowOrientation(heading);
        });

        // Handle step counting (Example logic)
        let steps = 0;
        window.addEventListener('devicemotion', function(event) {
            if (event.accelerationIncludingGravity) {
                let acc = event.accelerationIncludingGravity;
                let magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
                if (magnitude > 12) { // Simple threshold to count steps
                    steps++;
                    document.getElementById('steps').innerText = `Steps: ${steps}`;
                }
            }
        });

        // Button to show/hide map
        showHideMapBtn.addEventListener('click', function() {
            mapVisible = !mapVisible;
            if (mapVisible) {
                mapContainer.style.display = 'block';
                showHideMapBtn.innerText = 'HIDE MAP';
            } else {
                mapContainer.style.display = 'none';
                showHideMapBtn.innerText = 'SHOW MAP';
            }
        });

        // Button to reset tracker
        document.getElementById('resetBtn').addEventListener('click', function() {
            steps = 0;
            document.getElementById('steps').innerText = `Steps: ${steps}`;
        });

        // Initialize everything
        initCamera();
        init3DArrow();
        animate();
    </script>
</body>
</html>
