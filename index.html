<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Arrow in Video Feed</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #222;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #video {
      width: 100%;
      height: 50%;
      object-fit: cover;
      display: block;
      position: relative;
    }

    #controls {
      background-color: #333;
      color: white;
      padding: 10px;
      text-align: center;
      flex: 1;
    }

    #arrow-container {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      transform-origin: center;
      transform: translate(-50%, -50%);
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #arrow-head {
      width: 60px;
      height: 60px;
      background-color: transparent;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 40px solid red;
      transform-origin: center;
      transition: transform 0.1s ease-in-out;
    }

    .direction-text {
      font-size: 18px;
      margin: 10px;
    }

    #sensor-info {
      color: white;
      font-size: 18px;
      position: relative;
      bottom: 10px;
    }

    #map {
      display: none;
      width: 100%;
      height: 50%;
      background-color: #fff;
      position: absolute;
      top: 50%;
      left: 0;
    }

    #toggle-button, #reset-button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #toggle-button {
      background-color: #444;
    }

    #reset-button {
      background-color: #d9534f;
    }

    .step-info {
      font-size: 20px;
      margin: 10px;
    }
  </style>
</head>
<body>

  <video id="video" autoplay></video>

  <div id="controls">
    <div class="direction-text" id="direction">üìç Direction: Waiting for data...</div>
    <div class="step-info" id="steps">Steps: 0</div>
    <div class="direction-text" id="orientation">Orientation: Waiting for data...</div>
    <button id="reset-button" onclick="resetStepCounter()">üîÑ Reset Step Counter</button>
    <button id="toggle-button" onclick="toggleView()">Show Map</button>
  </div>

  <div id="sensor-info">üìç Waiting for sensor data...</div>

  <div id="arrow-container">
    <div id="arrow-head"></div>
  </div>

  <div id="map">
    <canvas id="map-canvas" width="640" height="640"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const arrowContainer = document.getElementById('arrow-container');
    const arrowHead = document.getElementById('arrow-head');
    const directionText = document.getElementById('direction');
    const stepsText = document.getElementById('steps');
    const orientationText = document.getElementById('orientation');
    const sensorInfo = document.getElementById('sensor-info');
    const toggleButton = document.getElementById('toggle-button');
    const mapDiv = document.getElementById('map');
    const resetButton = document.getElementById('reset-button');

    let heading = 0; // Heading in degrees
    let stepCount = 0;
    let lastStepTime = 0;
    let lastMagnitude = 0;
    const stepThreshold = 12.5;
    const minStepInterval = 400;
    const alpha = 0.8; // Low-pass filter for smooth acceleration data

    // Initialize video feed
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(function (stream) {
        video.srcObject = stream;
      })
      .catch(function (error) {
        console.error("Error accessing camera: ", error);
      });

    // Update the position and orientation of the 3D arrow
    function updateArrowPosition() {
      const rotationX = (heading - 90) * Math.PI / 180; // Convert to radians and adjust for screen coordinates
      const transformValue = `rotateY(${rotationX}rad)`; // Rotate around Y-axis (vertical)

      // Apply the rotation to the arrow
      arrowHead.style.transform = transformValue;  // Rotate only the head of the arrow
    }

    // Use device orientation to get the heading
    window.addEventListener('deviceorientation', (event) => {
      heading = event.alpha || 0; // alpha gives us the heading in degrees
      updateArrowPosition();
      updateDirection();
    });

    // Use device motion to detect steps (based on acceleration)
    window.addEventListener('devicemotion', (event) => {
      const acc = event.accelerationIncludingGravity;
      if (!acc.x || !acc.y || !acc.z) return;

      const rawMagnitude = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
      const magnitude = alpha * lastMagnitude + (1 - alpha) * rawMagnitude;
      lastMagnitude = magnitude;

      const now = Date.now();
      if (magnitude > stepThreshold && (now - lastStepTime > minStepInterval)) {
        stepCount++;
        lastStepTime = now;
        stepsText.innerText = `Steps: ${stepCount}`;
      }
    });

    // Update the direction text (East, West, etc.)
    function updateDirection() {
      let direction;
      if (heading >= 337.5 || heading < 22.5) {
        direction = "North";
      } else if (heading >= 22.5 && heading < 67.5) {
        direction = "North-East";
      } else if (heading >= 67.5 && heading < 112.5) {
        direction = "East";
      } else if (heading >= 112.5 && heading < 157.5) {
        direction = "South-East";
      } else if (heading >= 157.5 && heading < 202.5) {
        direction = "South";
      } else if (heading >= 202.5 && heading < 247.5) {
        direction = "South-West";
      } else if (heading >= 247.5 && heading < 292.5) {
        direction = "West";
      } else if (heading >= 292.5 && heading < 337.5) {
        direction = "North-West";
      }
      directionText.innerText = `üìç Direction: ${direction}`;
      orientationText.innerText = `Orientation: ${heading.toFixed(2)}¬∞`;
    }

    // Reset the step counter
    function resetStepCounter() {
      stepCount = 0;
      stepsText.innerText = `Steps: 0`;
    }

    // Toggle between map and video feed
    function toggleView() {
      if (video.style.display === 'none') {
        video.style.display = 'block';
        mapDiv.style.display = 'none';
        toggleButton.innerText = 'Show Map';
      } else {
        video.style.display = 'none';
        mapDiv.style.display = 'block';
        toggleButton.innerText = 'Show Video';
      }
    }

    // Wait for the user to open the rear camera
    function onCameraReady() {
      sensorInfo.innerText = 'üì∏ Rear camera is ready!';
      video.style.display = 'block';
    }

    // Show instructions after camera access is granted
    window.onload = function () {
      setTimeout(() => {
        onCameraReady();
      }, 2000); // Simulate message delay until camera is ready
    };
  </script>

</body>
</html>
